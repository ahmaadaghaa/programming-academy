<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إنشاء حساب - أكاديمية البرمجة المتكاملة</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary-color: #2563eb;
        --secondary-color: #f59e0b;
        --dark-color: #1e293b;
        --light-color: #f8fafc;
        --gradient: linear-gradient(135deg, #2563eb, #7c3aed);
        --success-color: #10b981;
        --error-color: #ef4444;
      }

      body {
        background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem 1rem;
        overflow-x: hidden;
      }

      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .register-container {
        display: flex;
        width: 90%;
        max-width: 1100px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 30px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        animation: slideUp 1s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .register-left {
        flex: 1;
        background: linear-gradient(
          135deg,
          rgba(37, 99, 235, 0.9),
          rgba(124, 58, 237, 0.9)
        );
        color: white;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .register-left::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 1px,
          transparent 1px
        );
        background-size: 20px 20px;
        animation: float 20s linear infinite;
      }

      @keyframes float {
        0% {
          transform: translate(0, 0) rotate(0deg);
        }
        100% {
          transform: translate(-50px, -50px) rotate(360deg);
        }
      }

      .register-left h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        position: relative;
        z-index: 2;
      }

      .register-left p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 2rem;
        line-height: 1.6;
        position: relative;
        z-index: 2;
      }

      .features-list {
        list-style: none;
        position: relative;
        z-index: 2;
      }

      .features-list li {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .features-list i {
        color: var(--secondary-color);
      }

      .register-right {
        flex: 1.2;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        position: relative;
      }

      .progress-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
      }

      .progress-bar::before {
        content: "";
        position: absolute;
        top: 15px;
        right: 0;
        left: 0;
        height: 4px;
        background: #e2e8f0;
        z-index: 1;
      }

      .progress-bar::after {
        content: "";
        position: absolute;
        top: 15px;
        right: 0;
        width: 33%;
        height: 4px;
        background: var(--gradient);
        z-index: 2;
        transition: width 0.5s ease;
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 3;
      }

      .step-number {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
      }

      .progress-step.active .step-number {
        background: var(--gradient);
        color: white;
        box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
      }

      .step-label {
        font-size: 0.8rem;
        color: #64748b;
      }

      .progress-step.active .step-label {
        color: var(--primary-color);
        font-weight: bold;
      }

      .register-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .register-header h2 {
        font-size: 2rem;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
      }

      .register-header p {
        color: #64748b;
      }

      .form-step {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-step.active {
        display: block;
      }

      .input-group {
        margin-bottom: 1.5rem;
        position: relative;
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid #e2e8f0;
        border-radius: 15px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8fafc;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 5px 15px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
      }

      .input-group i {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        transition: color 0.3s ease;
      }

      .input-group input:focus + i,
      .input-group select:focus + i {
        color: var(--primary-color);
      }

      .name-row {
        display: flex;
        gap: 1rem;
      }

      .name-row .input-group {
        flex: 1;
      }

      .password-strength {
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .password-strength-bar {
        height: 100%;
        width: 0%;
        border-radius: 3px;
        transition: width 0.3s ease, background 0.3s ease;
      }

      .password-requirements {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: #64748b;
      }

      .requirement {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 0.2rem;
      }

      .requirement i {
        font-size: 0.7rem;
      }

      .requirement.valid {
        color: var(--success-color);
      }

      .requirement.invalid {
        color: #64748b;
      }

      .form-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
      }

      .btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 15px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-prev {
        background: #f1f5f9;
        color: #64748b;
      }

      .btn-prev:hover {
        background: #e2e8f0;
        transform: translateY(-2px);
      }

      .btn-next,
      .btn-submit {
        background: var(--gradient);
        color: white;
      }

      .btn-next:hover,
      .btn-submit:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
      }

      .login-link {
        text-align: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
      }

      .login-link a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: bold;
        transition: color 0.3s ease;
      }

      .login-link a:hover {
        color: var(--secondary-color);
      }

      .floating-shapes {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      .shape {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: floatShape 6s ease-in-out infinite;
      }

      .shape:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 10%;
        left: 10%;
        animation-delay: 0s;
      }

      .shape:nth-child(2) {
        width: 60px;
        height: 60px;
        top: 70%;
        left: 80%;
        animation-delay: 2s;
      }

      .shape:nth-child(3) {
        width: 100px;
        height: 100px;
        top: 40%;
        left: 20%;
        animation-delay: 4s;
      }

      @keyframes floatShape {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(180deg);
        }
      }

      /* Notification styles moved to shared site-notification.js (injected) */

      /* Responsive Design */
      @media (max-width: 968px) {
        .register-container {
          flex-direction: column;
          height: auto;
        }

        .register-left,
        .register-right {
          padding: 2rem;
        }

        .name-row {
          flex-direction: column;
          gap: 0;
        }
      }

      @media (max-width: 480px) {
        .register-left h1 {
          font-size: 2rem;
        }

        .register-header h2 {
          font-size: 1.5rem;
        }

        .btn {
          padding: 0.8rem 1.5rem;
        }
      }
    </style>
    <!-- <script src="user-manager.js"></script> -->
  </head>
  <body>
    <div class="register-container">
      <div class="register-left">
        <h1>انضم إلى مجتمعنا!</h1>
        <p>
          أنشئ حسابك اليوم وابدأ رحلتك في عالم البرمجة مع أفضل المنصات التعليمية
          العربية.
        </p>
        <ul class="features-list">
          <li><i class="fas fa-check"></i> وصول كامل إلى جميع الكورسات</li>
          <li><i class="fas fa-check"></i> متابعة تقدمك التعليمي</li>
          <li><i class="fas fa-check"></i> دعم مباشر من المبرمجين</li>
          <li><i class="fas fa-check"></i> شهادات معتمدة بعد الإنجاز</li>
          <li><i class="fas fa-check"></i> مشاريع عملية حقيقية</li>
          <li><i class="fas fa-check"></i> مجتمع تفاعلي للمبرمجين</li>
        </ul>

        <div class="floating-shapes">
          <div class="shape"></div>
          <div class="shape"></div>
          <div class="shape"></div>
        </div>
      </div>

      <div class="register-right">
        <div class="progress-bar">
          <div class="progress-step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">المعلومات الشخصية</div>
          </div>
          <div class="progress-step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">تفاصيل الحساب</div>
          </div>
          <div class="progress-step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">الاهتمامات</div>
          </div>
        </div>

        <div class="register-header">
          <h2>إنشاء حساب جديد</h2>
          <p>املأ المعلومات التالية لإنشاء حسابك</p>
        </div>

        <form id="registerForm">
          <!-- الخطوة 1: المعلومات الشخصية -->
          <div class="form-step active" id="step-1">
            <div class="name-row">
              <div class="input-group">
                <input
                  type="text"
                  id="firstName"
                  placeholder="الاسم الأول"
                  required
                />
                <i class="fas fa-user"></i>
              </div>
              <div class="input-group">
                <input
                  type="text"
                  id="lastName"
                  placeholder="اسم العائلة"
                  required
                />
                <i class="fas fa-user"></i>
              </div>
            </div>

            <div class="input-group">
              <input
                type="email"
                id="email"
                placeholder="البريد الإلكتروني"
                required
              />
              <i class="fas fa-envelope"></i>
            </div>

            <div class="input-group">
              <input type="tel" id="phone" placeholder="رقم الهاتف (اختياري)" />
              <i class="fas fa-phone"></i>
            </div>

            <div class="input-group">
              <select id="country" required>
                <option value="">اختر الدولة</option>
                <option value="SA">السعودية</option>
                <option value="EG">مصر</option>
                <option value="AE">الإمارات</option>
                <option value="JO">الأردن</option>
                <option value="LB">لبنان</option>
                <option value="KW">الكويت</option>
                <option value="QA">قطر</option>
                <option value="BH">البحرين</option>
                <option value="OM">عمان</option>
              </select>
              <i class="fas fa-globe"></i>
            </div>

            <div class="form-buttons">
              <button type="button" class="btn btn-next" id="next-1">
                التالي <i class="fas fa-arrow-left"></i>
              </button>
            </div>
          </div>

          <!-- الخطوة 2: تفاصيل الحساب -->
          <div class="form-step" id="step-2">
            <div class="input-group">
              <input
                type="text"
                id="username"
                placeholder="اسم المستخدم"
                required
              />
              <i class="fas fa-at"></i>
            </div>

            <div class="input-group">
              <input
                type="password"
                id="password"
                placeholder="كلمة المرور"
                required
              />
              <i class="fas fa-lock"></i>
              <div class="password-strength">
                <div
                  class="password-strength-bar"
                  id="password-strength-bar"
                ></div>
              </div>
              <div class="password-requirements">
                <div class="requirement invalid" id="req-length">
                  <i class="fas fa-circle"></i> 8 أحرف على الأقل
                </div>
                <div class="requirement invalid" id="req-uppercase">
                  <i class="fas fa-circle"></i> حرف كبير واحد على الأقل
                </div>
                <div class="requirement invalid" id="req-number">
                  <i class="fas fa-circle"></i> رقم واحد على الأقل
                </div>
                <div class="requirement invalid" id="req-special">
                  <i class="fas fa-circle"></i> رمز خاص واحد على الأقل
                </div>
              </div>
            </div>

            <div class="input-group">
              <input
                type="password"
                id="confirmPassword"
                placeholder="تأكيد كلمة المرور"
                required
              />
              <i class="fas fa-lock"></i>
            </div>

            <div class="form-buttons">
              <button type="button" class="btn btn-prev" id="prev-2">
                <i class="fas fa-arrow-right"></i> السابق
              </button>
              <button type="button" class="btn btn-next" id="next-2">
                التالي <i class="fas fa-arrow-left"></i>
              </button>
            </div>
          </div>

          <!-- الخطوة 3: الاهتمامات -->
          <div class="form-step" id="step-3">
            <div class="input-group">
              <select id="experience" required>
                <option value="">مستوى الخبرة في البرمجة</option>
                <option value="beginner">مبتدئ - لا خبرة سابقة</option>
                <option value="intermediate">متوسط - بعض المعرفة</option>
                <option value="advanced">متقدم - أستطيع كتابة برامج</option>
                <option value="expert">خبير - أطور مشاريع كاملة</option>
              </select>
              <i class="fas fa-code"></i>
            </div>

            <div class="input-group">
              <select id="goal" required>
                <option value="">الهدف من التعلم</option>
                <option value="job">الحصول على وظيفة</option>
                <option value="freelance">العمل الحر</option>
                <option value="personal">تطوير مهارات شخصية</option>
                <option value="startup">بناء مشروع خاص</option>
                <option value="academic">الدراسة الأكاديمية</option>
              </select>
              <i class="fas fa-bullseye"></i>
            </div>

            <div class="input-group">
              <select id="interest" required>
                <option value="">مجال الاهتمام الرئيسي</option>
                <option value="web">تطوير الويب</option>
                <option value="mobile">تطوير التطبيقات</option>
                <option value="ai">الذكاء الاصطناعي</option>
                <option value="data">علم البيانات</option>
                <option value="games">تطوير الألعاب</option>
                <option value="security">أمن المعلومات</option>
              </select>
              <i class="fas fa-heart"></i>
            </div>

            <div class="input-group">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  cursor: pointer;
                "
              >
                <input type="checkbox" id="terms" required />
                أوافق على
                <a href="terms.html" style="color: var(--primary-color)"
                  >شروط الاستخدام</a
                >
                و
                <a href="privacy.html" style="color: var(--primary-color)"
                  >سياسة الخصوصية</a
                >
              </label>
            </div>

            <div class="form-buttons">
              <button type="button" class="btn btn-prev" id="prev-3">
                <i class="fas fa-arrow-right"></i> السابق
              </button>
              <button type="submit" class="btn btn-submit" id="submit">
                إنشاء الحساب <i class="fas fa-user-plus"></i>
              </button>
            </div>
          </div>
        </form>

        <div class="login-link">
          <p>لديك حساب بالفعل؟ <a href="./login1.html">سجل الدخول الآن</a></p>
        </div>
      </div>
    </div>

    <!-- notification provided by shared script -->
    <script src="site-notification.js"></script>

    <script>
      // رابط API التسجيل
      const REGISTER_API_URL =
        "http://localhost//programming-academy/register_api.php";
      // رابط API التحقق الجديد
      const CHECK_API_URL =
        "http://localhost/programming-academy/check_availability_api.php";

      // ----------------------------------------------------
      // 1. تعريف عناصر DOM والمتغيرات
      // ----------------------------------------------------
      let currentStep = 1;
      const totalSteps = 3;

      // عناصر DOM الأساسية
      const registerForm = document.getElementById("registerForm");
      const submitButton = document.getElementById("submit");

      // عناصر DOM الخاصة بالخطوات وشريط التقدم
      const progressBar = document.querySelector(".progress-bar");
      const progressSteps = document.querySelectorAll(".progress-step");
      const formSteps = document.querySelectorAll(".form-step");
      const nextButtons = document.querySelectorAll(".btn-next");
      const prevButtons = document.querySelectorAll(".btn-prev");

      // عناصر DOM الخاصة بكلمة المرور
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const passwordStrengthBar = document.getElementById(
        "password-strength-bar"
      );
      const passwordRequirements = document.querySelectorAll(".requirement");

      // ----------------------------------------------------
      // 2. وظائف النموذج متعدد الخطوات (لم تتغير)
      // ----------------------------------------------------

      // تحديث شريط التقدم
      function updateProgressBar() {
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        if (progressBar) {
          progressBar.style.setProperty("--progress", `${progress}%`);
        }

        progressSteps.forEach((step, index) => {
          if (index < currentStep) {
            step.classList.add("active");
          } else {
            step.classList.remove("active");
          }
        });
      }

      // الانتقال بين الخطوات
      function goToStep(step) {
        formSteps.forEach((formStep) => {
          formStep.classList.remove("active");
        });

        const nextStepElement = document.getElementById(`step-${step}`);
        if (nextStepElement) {
          nextStepElement.classList.add("active");
          currentStep = step;
          updateProgressBar();
        }
      }

      // ... (باقي دوال التحقق من كلمة المرور: checkPasswordStrength, checkPasswordMatch) ...

      function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password),
        };
        if (passwordRequirements && passwordRequirements.length > 0) {
          Object.keys(requirements).forEach((key, index) => {
            const requirementElement = passwordRequirements[index];
            if (requirementElement) {
              if (requirements[key]) {
                requirementElement.classList.remove("invalid");
                requirementElement.classList.add("valid");
                requirementElement.innerHTML = `<i class="fas fa-check"></i> ${requirementElement.textContent
                  .split(" ")
                  .slice(1)
                  .join(" ")}`;
                strength++;
              } else {
                requirementElement.classList.remove("valid");
                requirementElement.classList.add("invalid");
                requirementElement.innerHTML = `<i class="fas fa-circle"></i> ${requirementElement.textContent
                  .split(" ")
                  .slice(1)
                  .join(" ")}`;
              }
            }
          });
        }
        const strengthPercent = (strength / 4) * 100;
        if (passwordStrengthBar) {
          passwordStrengthBar.style.width = `${strengthPercent}%`;
          if (strengthPercent < 25) {
            passwordStrengthBar.style.background = "#ef4444";
          } else if (strengthPercent < 50) {
            passwordStrengthBar.style.background = "#f59e0b";
          } else if (strengthPercent < 75) {
            passwordStrengthBar.style.background = "#3b82f6";
          } else {
            passwordStrengthBar.style.background = "#10b981";
          }
        }
        return strength >= 3;
      }

      function checkPasswordMatch() {
        if (!passwordInput || !confirmPasswordInput) return true;
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        if (confirmPassword && password !== confirmPassword) {
          confirmPasswordInput.style.borderColor = "var(--error-color)";
          return false;
        } else {
          confirmPasswordInput.style.borderColor = "";
          return true;
        }
      }

      // التحقق من صحة الخطوة الحالية (التحقق المحلي فقط)
      function validateStep(step) {
        const currentForm = document.getElementById(`step-${step}`);
        if (!currentForm) return false;

        const inputs = currentForm.querySelectorAll(
          "input[required], select[required]"
        );

        for (let input of inputs) {
          if (!input.value) {
            input.focus();
            return false;
          }
        }

        // تحقق إضافي للخطوة 2 (كلمة المرور)
        if (step === 2 && passwordInput && confirmPasswordInput) {
          if (!checkPasswordStrength(passwordInput.value)) {
            showNotification(
              "كلمة المرور ضعيفة. يرجى اختيار كلمة مرور أقوى.",
              "error"
            );
            return false;
          }
          if (!checkPasswordMatch()) {
            showNotification("كلمتا المرور غير متطابقتين.", "error");
            return false;
          }
        }

        // تحقق إضافي للخطوة 3 (الشروط)
        if (step === 3) {
          const termsCheckbox = document.getElementById("terms");
          if (termsCheckbox && !termsCheckbox.checked) {
            showNotification(
              "يجب الموافقة على الشروط والأحكام للمتابعة.",
              "error"
            );
            return false;
          }
        }

        return true;
      }

      // ----------------------------------------------------
      // وظيفة التحقق من التكرار عبر API (الجديدة)
      // ----------------------------------------------------

      // وظيفة التحقق من التكرار عبر API
      async function checkDuplicationAvailability(payload) {
        // payload is an object with the fields to check, e.g. { email, phone } or { username }
        try {
          const response = await fetch(CHECK_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const error = await response.json();
            const errorMessage =
              error.message || "خطأ في التحقق من البيانات. حاول لاحقاً.";
            // highlight the conflicting inputs if provided
            if (error.fields && Array.isArray(error.fields)) {
              error.fields.forEach((f) => {
                const el = document.getElementById(
                  f === "username"
                    ? "username"
                    : f === "phone"
                    ? "phone"
                    : "email"
                );
                if (el) {
                  el.focus();
                  el.style.borderColor = "#ef4444";
                }
              });
            }
            showNotification(errorMessage, "error");
            return false;
          }

          // success
          return true;
        } catch (ex) {
          showNotification(
            "فشل الاتصال بخادم التحقق. تحقق من اتصالك.",
            "error"
          );
          return false;
        }
      }

      // ----------------------------------------------------
      // 3. معالجة الأحداث (Event Listeners) - مُحدثة
      // ----------------------------------------------------

      // معالجة النقر على أزرار التالي (مُحدثة لتكون Async)
      nextButtons.forEach((button) => {
        button.addEventListener("click", async function () {
          const stepId = this.id.split("-")[1];
          const step = parseInt(stepId);

          // 1. التحقق المحلي للحقول المطلوبة
          if (validateStep(step)) {
            if (step === 1) {
              // 2. خطوة إضافية: التحقق من التكرار عبر الخادم

              // استخراج البيانات من حقول الخطوة الأولى
              const email = document.getElementById("email").value.trim();
              const phone = document.getElementById("phone").value.trim();

              // تعطيل الزر مؤقتاً أثناء التحقق
              this.disabled = true;
              this.innerHTML =
                '<i class="fa fa-spinner fa-spin"></i> جاري التحقق...';

              const isAvailable = await checkDuplicationAvailability({
                email,
                phone,
              });

              // إعادة الزر لوضعه الطبيعي
              this.disabled = false;
              this.textContent = "التالي";

              if (isAvailable) {
                goToStep(step + 1); // التحقق ناجح، انتقل إلى الخطوة 2
              } else {
                // التحقق فاشل، ابقَ في الخطوة 1 (الرسالة تظهر في الإشعار)
              }
            } else if (step === 2) {
              // When moving from step 2, check username only
              const username = document.getElementById("username").value.trim();
              if (!username) {
                showNotification("يرجى إدخال اسم المستخدم أولاً.", "error");
                return;
              }
              this.disabled = true;
              this.innerHTML =
                '<i class="fa fa-spinner fa-spin"></i> جاري التحقق...';
              const isAvailable = await checkDuplicationAvailability({
                username,
              });
              this.disabled = false;
              this.textContent = "التالي";
              if (isAvailable) goToStep(step + 1);
            } else {
              // للخطوات الأخرى، انتقل مباشرة
              goToStep(step + 1);
            }
          }
        });
      });

      // معالجة النقر على أزرار السابق (لم تتغير)
      prevButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const stepId = this.id.split("-")[1];
          const step = parseInt(stepId);
          goToStep(step - 1);
        });
      });

      // مراقبة حقول كلمة المرور
      if (passwordInput)
        passwordInput.addEventListener("input", function () {
          checkPasswordStrength(this.value);
          checkPasswordMatch();
        });
      if (confirmPasswordInput)
        confirmPasswordInput.addEventListener("input", checkPasswordMatch);

      // reset error styling when user edits conflict fields
      ["email", "phone", "username"].forEach((id) => {
        const el = document.getElementById(id);
        if (el)
          el.addEventListener("input", function () {
            this.style.borderColor = "";
          });
      });

      // ----------------------------------------------------
      // وظيفة معالجة الإرسال النهائي (لم تتغير، ولكن الآن التحقق من التكرار صار مسبقاً)
      // ----------------------------------------------------
      if (registerForm) {
        registerForm.addEventListener("submit", function (e) {
          e.preventDefault();

          // التحقق النهائي من الخطوة الأخيرة قبل الإرسال الفعلي
          if (!validateStep(totalSteps)) {
            return;
          }

          // إعداد الإرسال
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML =
              '<i class="fa fa-spinner fa-spin"></i> جاري إنشاء الحساب...';
          }
          // nothing to do; shared notification handles hide

          const requestData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            phone: document.getElementById("phone").value,
            country: document.getElementById("country").value,
            experience: document.getElementById("experience").value,
            goal: document.getElementById("goal").value,
            interest: document.getElementById("interest").value,
          };

          fetch(REGISTER_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          })
            .then((response) => {
              if (!response.ok)
                return response.json().then((err) => Promise.reject(err));
              return response.json();
            })
            .then((data) => {
              showNotification(data.message, "success");
              setTimeout(() => (window.location.href = "./profile.html"), 1200);
            })
            .catch((error) => {
              const errorMessage =
                error.message || "فشل الاتصال بالخادم. حاول مرة أخرى.";
              showNotification(errorMessage, "error");
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = "إنشاء حساب جديد";
              }
              console.error("Registration Error:", error);
            });
        });
      }

      // ----------------------------------------------------
      // 4. تهيئة النظام عند تحميل الصفحة
      // ----------------------------------------------------
      window.addEventListener("load", function () {
        // Check if user is already logged in
        fetch("user_status.php", { credentials: "same-origin" })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success && data.user) {
              window.location.href = "index.html";
              return;
            }
            updateProgressBar();
          })
          .catch((error) => {
            console.error("Error checking user status:", error);
            updateProgressBar();
          });
      });
    </script>
  </body>
</html>
